<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>conversation stats</title>
  <link rel="icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHZpZXdCb3g9JzAgMCAzMiAzMic+PGRlZnM+PGxpbmVhckdyYWRpZW50IGlkPSdhJyB4MT0nMCcgeTE9JzEnIHgyPScxJyB5Mj0nMCc+PHN0b3Agb2Zmc2V0PSczMyUnIHN0b3AtY29sb3I9JyNlODc5ZjknLz48c3RvcCBvZmZzZXQ9JzMzJScgc3RvcC1jb2xvcj0nI2ZiYmYyNCcvPjxzdG9wIG9mZnNldD0nNjYlJyBzdG9wLWNvbG9yPScjZmJiZjI0Jy8+PHN0b3Agb2Zmc2V0PSc2NiUnIHN0b3AtY29sb3I9JyMyMmQzZWUnLz48L2xpbmVhckdyYWRpZW50PjxsaW5lYXJHcmFkaWVudCBpZD0nYicgeDE9JzAnIHkxPScxJyB4Mj0nMScgeTI9JzAnPjxzdG9wIG9mZnNldD0nNTAlJyBzdG9wLWNvbG9yPScjNjBhNWZhJy8+PHN0b3Agb2Zmc2V0PSc1MCUnIHN0b3AtY29sb3I9JyM2ZWU3YjcnLz48L2xpbmVhckdyYWRpZW50PjxsaW5lYXJHcmFkaWVudCBpZD0nYycgeDE9JzAnIHkxPScxJyB4Mj0nMScgeTI9JzAnPjxzdG9wIG9mZnNldD0nNTAlJyBzdG9wLWNvbG9yPScjM2I4MmY2Jy8+PHN0b3Agb2Zmc2V0PSc1MCUnIHN0b3AtY29sb3I9JyNmODcxNzEnLz48L2xpbmVhckdyYWRpZW50PjwvZGVmcz48cmVjdCB3aWR0aD0nMTQnIGhlaWdodD0nMTQnIHg9JzEnIHk9JzEnIHJ4PScxJyBmaWxsPSd1cmwoI2EpJy8+PHJlY3Qgd2lkdGg9JzE0JyBoZWlnaHQ9JzE0JyB4PScxNycgeT0nMScgcng9JzEnIGZpbGw9JyM2ZWU3YjcnLz48cmVjdCB3aWR0aD0nMTQnIGhlaWdodD0nMTQnIHg9JzEnIHk9JzE3JyByeD0nMScgZmlsbD0ndXJsKCNiKScvPjxyZWN0IHdpZHRoPScxNCcgaGVpZ2h0PScxNCcgeD0nMTcnIHk9JzE3JyByeD0nMScgZmlsbD0ndXJsKCNjKScvPjwvc3ZnPg==">
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    :root {
      --canvas-base: #0a0a0b;
      --canvas-surface: #131316;
      --canvas-elevated: #1a1a1f;
      --border: #2a2a2f;
      --border-strong: #3a3a42;
      --text-primary: #e4e4e7;
      --text-secondary: #a1a1aa;
      --text-tertiary: #71717a;
      --accent-primary: #3b82f6;
      --accent-surface: #3b82f615;
      --heat-0: #1a1a1f;
      --heat-1: #1e3a5f;
      --heat-2: #2563eb;
      --heat-3: #3b82f6;
      --heat-4: #60a5fa;
      --heat-5: #93c5fd;
    }

    html, body {
      height: 100%;
      background: var(--canvas-base);
      color: var(--text-primary);
      font-family: 'SF Mono', 'Fira Code', 'JetBrains Mono', Consolas, monospace;
      font-size: 12px;
      line-height: 1.5;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px;
    }

    /* Header */
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border);
    }

    .title {
      font-size: 14px;
      text-transform: lowercase;
      letter-spacing: 0.15em;
      color: var(--text-secondary);
    }

    .month-nav {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .month-nav button {
      background: var(--canvas-surface);
      border: 1px solid var(--border);
      color: var(--text-primary);
      padding: 6px 12px;
      font-family: inherit;
      font-size: 11px;
      text-transform: lowercase;
      letter-spacing: 0.08em;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .month-nav button:hover {
      border-color: var(--border-strong);
      background: var(--canvas-elevated);
    }

    .month-label {
      font-size: 13px;
      text-transform: lowercase;
      letter-spacing: 0.1em;
      color: var(--text-primary);
      min-width: 120px;
      text-align: center;
    }

    /* Drop Zone */
    .drop-zone {
      border: 2px dashed var(--border);
      padding: 40px;
      text-align: center;
      margin-bottom: 24px;
      transition: all 0.2s ease;
      cursor: pointer;
    }

    .drop-zone:hover,
    .drop-zone.dragover {
      border-color: var(--accent-primary);
      background: var(--accent-surface);
    }

    .drop-zone-text {
      color: var(--text-tertiary);
      text-transform: lowercase;
      letter-spacing: 0.1em;
    }

    .drop-zone-text span {
      color: var(--accent-primary);
    }

    .file-count {
      margin-top: 12px;
      font-size: 11px;
      color: var(--text-secondary);
      text-transform: lowercase;
      letter-spacing: 0.08em;
    }

    /* Stats bar */
    .stats-bar {
      display: flex;
      justify-content: space-between;
      margin-bottom: 24px;
      padding: 12px 16px;
      background: var(--canvas-surface);
      border: 1px solid var(--border);
    }

    .stats-group {
      display: flex;
      gap: 20px;
      align-items: baseline;
    }

    .stats-group-label {
      font-size: 10px;
      color: var(--text-tertiary);
      text-transform: lowercase;
      letter-spacing: 0.1em;
      opacity: 0.6;
      margin-right: 4px;
    }

    .stats-expand-arrow {
      font-size: 10px;
      color: var(--text-tertiary);
      padding: 6px 8px;
      cursor: pointer;
      border-radius: 3px;
      transition: transform 0.2s ease;
      margin-right: 2px;
    }

    .stats-expand-arrow:hover {
      color: var(--text-primary);
      background: var(--canvas-elevated);
    }

    .stats-expand-arrow.open {
      transform: rotate(90deg);
    }

    .stats-charts-row {
      display: flex;
      gap: 16px;
      margin-bottom: 24px;
    }

    .stats-chart-panel {
      flex: 1;
      background: var(--canvas-surface);
      border: 1px solid var(--border);
      padding: 12px 16px;
    }

    .stats-chart-panel .chart-bars {
      display: flex;
      flex-direction: column;
      gap: 3px;
    }

    .stats-chart-panel .chart-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .stats-chart-panel .chart-label {
      font-size: 10px;
      color: var(--text-tertiary);
      min-width: 50px;
      text-align: right;
      letter-spacing: 0.05em;
    }

    .stats-chart-panel .chart-bar-track {
      flex: 1;
      height: 14px;
      background: var(--canvas-elevated);
      overflow: hidden;
    }

    .stats-chart-panel .chart-bar-fill {
      height: 100%;
      background: var(--accent-primary);
      transition: width 0.3s ease;
    }

    .stats-chart-panel .chart-value {
      font-size: 10px;
      color: var(--text-secondary);
      min-width: 40px;
      text-align: right;
    }

    .stats-chart-panel .chart-title {
      font-size: 10px;
      color: var(--text-tertiary);
      margin-bottom: 8px;
      letter-spacing: 0.1em;
      text-transform: lowercase;
    }

    .stat-item {
      display: flex;
      align-items: baseline;
      gap: 8px;
    }

    .stat-label {
      color: var(--text-tertiary);
      text-transform: lowercase;
      letter-spacing: 0.08em;
      font-size: 11px;
    }

    .stat-value {
      color: var(--accent-primary);
      font-size: 14px;
    }

    /* Heatmap */
    .heatmap-container {
      background: var(--canvas-surface);
      border: 1px solid var(--border);
      padding: 20px;
      overflow-x: auto;
    }

    .heatmap {
      display: grid;
      grid-template-columns: 40px repeat(24, 1fr);
      gap: 2px;
      min-width: 600px;
    }

    .heatmap-header {
      font-size: 10px;
      color: var(--text-tertiary);
      text-align: center;
      padding: 4px 0;
      text-transform: lowercase;
    }

    .heatmap-row {
      display: contents;
    }

    .day-label {
      font-size: 10px;
      color: var(--text-tertiary);
      display: flex;
      align-items: center;
      justify-content: flex-end;
      padding-right: 8px;
    }

    .heatmap-cell {
      aspect-ratio: 1;
      min-width: 20px;
      min-height: 20px;
      background: var(--heat-0);
      cursor: pointer;
      transition: all 0.15s ease;
      position: relative;
    }

    .heatmap-cell:hover {
      transform: scale(1.1);
      z-index: 10;
      box-shadow: 0 0 0 2px var(--accent-primary);
    }

    .heatmap-cell.heat-1 { background: var(--heat-1); }
    .heatmap-cell.heat-2 { background: var(--heat-2); }
    .heatmap-cell.heat-3 { background: var(--heat-3); }
    .heatmap-cell.heat-4 { background: var(--heat-4); }
    .heatmap-cell.heat-5 { background: var(--heat-5); }

    .heatmap-cell[title]:hover::after {
      content: attr(title);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: var(--canvas-elevated);
      border: 1px solid var(--border);
      padding: 4px 8px;
      font-size: 10px;
      white-space: nowrap;
      z-index: 100;
      margin-bottom: 4px;
    }

    /* Day row click highlight */
    .day-row-clickable {
      cursor: pointer;
    }

    .day-row-clickable:hover .day-label {
      color: var(--accent-primary);
    }

    /* Legend */
    .legend {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 16px;
      justify-content: flex-end;
    }

    .legend-label {
      font-size: 10px;
      color: var(--text-tertiary);
      text-transform: lowercase;
      letter-spacing: 0.05em;
    }

    .legend-scale {
      display: flex;
      gap: 2px;
    }

    .legend-box {
      width: 12px;
      height: 12px;
    }

    /* Modal / Overlay Views */
    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.85);
      z-index: 1000;
      overflow-y: auto;
      display: none;
    }

    .overlay.active {
      display: block;
    }

    .overlay-inner {
      max-width: 900px;
      margin: 0 auto;
      min-height: 100%;
      background: var(--canvas-base);
      position: relative;
    }

    .overlay-header {
      position: sticky;
      top: 0;
      background: var(--canvas-base);
      border-bottom: 1px solid var(--border);
      padding: 16px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      z-index: 10;
    }

    .overlay-title {
      font-size: 13px;
      text-transform: lowercase;
      letter-spacing: 0.1em;
      color: var(--text-secondary);
    }

    .overlay-close {
      background: var(--canvas-surface);
      border: 1px solid var(--border);
      color: var(--text-tertiary);
      padding: 6px 12px;
      font-family: inherit;
      font-size: 10px;
      text-transform: lowercase;
      letter-spacing: 0.08em;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .overlay-close:hover {
      border-color: var(--border-strong);
      color: var(--text-primary);
    }

    .overlay-content {
      padding: 24px;
    }

    /* Conversation List */
    .convo-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .convo-item {
      background: var(--canvas-surface);
      border: 1px solid var(--border);
      padding: 16px;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .convo-item:hover {
      border-color: var(--accent-primary);
      background: var(--canvas-elevated);
    }

    .convo-time {
      font-size: 11px;
      color: var(--accent-primary);
      text-transform: lowercase;
      letter-spacing: 0.08em;
      margin-bottom: 4px;
    }

    .convo-preview {
      font-size: 12px;
      color: var(--text-secondary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .convo-meta {
      margin-top: 8px;
      font-size: 10px;
      color: var(--text-tertiary);
      text-transform: lowercase;
      letter-spacing: 0.05em;
    }

    /* Conversation View */
    .message {
      margin-bottom: 24px;
      padding-bottom: 24px;
      border-bottom: 1px solid var(--border);
    }

    .message:last-child {
      border-bottom: none;
    }

    .message-role {
      font-size: 10px;
      text-transform: lowercase;
      letter-spacing: 0.1em;
      margin-bottom: 8px;
      padding: 4px 8px;
      display: inline-block;
    }

    .message-role.user {
      background: var(--accent-surface);
      color: var(--accent-primary);
    }

    .message-role.assistant {
      background: var(--canvas-elevated);
      color: var(--text-secondary);
    }

    .message-time {
      font-size: 10px;
      color: var(--text-tertiary);
      letter-spacing: 0.05em;
      margin-left: 8px;
    }

    .message-role-line {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
    }

    .message.highlighted {
      border-left: 2px solid var(--accent-primary);
      padding-left: 22px;
      background: var(--accent-surface);
    }

    .message-content {
      color: var(--text-primary);
      line-height: 1.7;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .message-content code {
      background: var(--canvas-elevated);
      padding: 2px 6px;
      font-size: 11px;
    }

    .message-content pre {
      background: var(--canvas-elevated);
      padding: 16px;
      overflow-x: auto;
      margin: 12px 0;
      border: 1px solid var(--border);
    }

    /* Toggle */
    .toggle-container {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 16px;
    }

    .toggle-label {
      font-size: 11px;
      color: var(--text-tertiary);
      text-transform: lowercase;
      letter-spacing: 0.05em;
    }

    .toggle-switch {
      display: flex;
      background: var(--canvas-surface);
      border: 1px solid var(--border);
    }

    .toggle-option {
      padding: 6px 12px;
      font-size: 10px;
      text-transform: lowercase;
      letter-spacing: 0.05em;
      cursor: pointer;
      color: var(--text-tertiary);
      transition: all 0.15s ease;
      border: none;
      background: transparent;
      font-family: inherit;
    }

    .toggle-option.active {
      background: var(--accent-primary);
      color: var(--canvas-base);
    }

    .toggle-option:hover:not(.active) {
      color: var(--text-primary);
    }

    /* Weekly summary */
    .weekly-summary {
      margin-bottom: 24px;
    }

    .weekly-summary-title {
      font-size: 11px;
      text-transform: lowercase;
      letter-spacing: 0.15em;
      color: var(--text-tertiary);
      margin-bottom: 10px;
    }

    .week-cards {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .week-card {
      background: var(--canvas-surface);
      border: 1px solid var(--border);
      padding: 12px 16px;
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 6px 16px;
      align-items: center;
      cursor: pointer;
      transition: border-color 0.15s ease;
    }

    .week-card:hover {
      border-color: var(--border-strong);
    }

    .week-label {
      font-size: 11px;
      color: var(--text-primary);
      letter-spacing: 0.05em;
    }

    .week-stats {
      display: flex;
      gap: 16px;
      align-items: center;
    }

    .week-stat {
      text-align: right;
    }

    .week-stat .num {
      font-size: 16px;
      font-weight: 600;
      color: var(--accent-primary);
      line-height: 1;
    }

    .week-stat .lbl {
      font-size: 9px;
      color: var(--text-tertiary);
      text-transform: lowercase;
      letter-spacing: 0.08em;
    }

    .week-bar-track {
      grid-column: 1 / -1;
      height: 3px;
      background: var(--canvas-elevated);
      overflow: hidden;
    }

    .week-bar-fill {
      height: 100%;
      background: #a78bfa;
      transition: width 0.4s ease;
    }

    .week-days {
      grid-column: 1 / -1;
      display: none;
      flex-direction: column;
      gap: 3px;
      padding-top: 8px;
      border-top: 1px solid var(--border);
      margin-top: 4px;
    }

    .week-days.open {
      display: flex;
    }

    .day-bar-row {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 2px 0;
      cursor: pointer;
      transition: background 0.15s ease;
    }

    .day-bar-row:hover {
      background: var(--canvas-elevated);
    }

    .day-bar-label {
      font-size: 10px;
      color: var(--text-tertiary);
      width: 28px;
      text-align: right;
      flex-shrink: 0;
      text-transform: lowercase;
    }

    .day-bar-track-inner {
      flex: 1;
      height: 4px;
      background: var(--canvas-elevated);
      overflow: hidden;
    }

    .day-bar-fill-inner {
      height: 100%;
      background: var(--heat-2);
      transition: width 0.3s ease;
    }

    .day-bar-count {
      font-size: 9px;
      color: var(--text-tertiary);
      width: 70px;
      flex-shrink: 0;
      letter-spacing: 0.05em;
    }

    /* Project tags */
    .week-projects {
      grid-column: 1 / -1;
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
    }

    .project-tag {
      font-size: 9px;
      color: #a78bfa;
      background: #a78bfa10;
      border: 1px solid #a78bfa20;
      padding: 2px 8px;
      letter-spacing: 0.05em;
    }

    .project-tag.new {
      color: #6ee7b7;
      background: #6ee7b710;
      border-color: #6ee7b730;
    }

    .project-tag {
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .project-tag:hover {
      border-color: #a78bfa60;
    }

    .project-tag.active {
      color: var(--canvas-base);
      background: #a78bfa;
      border-color: #a78bfa;
    }

    .project-tag.new.active {
      color: var(--canvas-base);
      background: #6ee7b7;
      border-color: #6ee7b7;
    }

    /* Filter bar */
    .filter-bar {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
      padding: 8px 12px;
      background: #a78bfa10;
      border: 1px solid #a78bfa30;
    }

    .filter-label {
      font-size: 10px;
      color: var(--text-tertiary);
      text-transform: lowercase;
      letter-spacing: 0.08em;
    }

    .filter-project {
      font-size: 11px;
      color: #a78bfa;
      letter-spacing: 0.05em;
    }

    .filter-clear {
      margin-left: auto;
      background: transparent;
      border: 1px solid #a78bfa30;
      color: #a78bfa;
      padding: 3px 10px;
      font-family: inherit;
      font-size: 10px;
      text-transform: lowercase;
      letter-spacing: 0.05em;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .filter-clear:hover {
      background: #a78bfa;
      color: var(--canvas-base);
    }

    .convo-project {
      font-size: 10px;
      color: #a78bfa;
      background: #a78bfa10;
      border: 1px solid #a78bfa20;
      padding: 2px 8px;
      display: inline-block;
      letter-spacing: 0.05em;
      margin-top: 6px;
    }

    /* View mode toggle */
    .view-mode-toggle {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }

    .view-mode-label {
      font-size: 10px;
      color: var(--text-tertiary);
      text-transform: lowercase;
      letter-spacing: 0.05em;
      transition: color 0.15s ease;
    }

    .view-mode-label.active-label {
      color: var(--text-primary);
    }

    .slide-toggle {
      position: relative;
      width: 32px;
      height: 16px;
      background: var(--canvas-elevated);
      border: 1px solid var(--border);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      flex-shrink: 0;
    }

    .slide-toggle::after {
      content: '';
      position: absolute;
      top: 2px;
      left: 2px;
      width: 10px;
      height: 10px;
      background: #a78bfa;
      border-radius: 50%;
      transition: transform 0.2s ease;
    }

    .slide-toggle.toggled::after {
      transform: translateX(16px);
    }

    /* Project ranking */
    .project-ranking {
      margin-bottom: 24px;
    }

    .project-ranking-title {
      font-size: 11px;
      text-transform: lowercase;
      letter-spacing: 0.15em;
      color: var(--text-tertiary);
      margin-bottom: 10px;
    }

    .project-rank-list {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .project-rank-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 12px;
      background: var(--canvas-surface);
      border: 1px solid var(--border);
      cursor: pointer;
      transition: border-color 0.15s ease;
    }

    .project-rank-item:hover {
      border-color: var(--border-strong);
    }

    .project-rank-item.active {
      border-color: #a78bfa;
      background: #a78bfa08;
    }

    .project-rank-pos {
      font-size: 10px;
      color: var(--text-tertiary);
      width: 16px;
      text-align: right;
    }

    .project-rank-name {
      font-size: 11px;
      color: var(--text-primary);
      flex: 1;
    }

    .project-rank-bar {
      flex: 1;
      height: 3px;
      background: var(--canvas-elevated);
      overflow: hidden;
      max-width: 200px;
    }

    .project-rank-bar-fill {
      height: 100%;
      background: #a78bfa;
      transition: width 0.3s ease;
    }

    .project-rank-msgs {
      font-size: 10px;
      color: var(--text-tertiary);
      min-width: 60px;
      text-align: right;
      letter-spacing: 0.05em;
    }

    .project-rank-item .expand-arrow {
      font-size: 10px;
      color: var(--text-tertiary);
      transition: transform 0.2s ease;
      padding: 6px 8px;
      margin: -6px 0;
      cursor: pointer;
      border-radius: 3px;
    }

    .project-rank-item .expand-arrow:hover {
      color: var(--text-primary);
      background: var(--canvas-elevated);
    }

    .project-rank-item .expand-arrow.open {
      transform: rotate(90deg);
    }

    .project-chart-panel {
      background: var(--canvas-surface);
      border: 1px solid var(--border);
      border-top: none;
      padding: 12px 16px;
      margin-bottom: 4px;
    }

    .project-chart-panel .chart-bars {
      display: flex;
      flex-direction: column;
      gap: 3px;
    }

    .project-chart-panel .chart-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .project-chart-panel .chart-label {
      font-size: 10px;
      color: var(--text-tertiary);
      min-width: 50px;
      text-align: right;
      letter-spacing: 0.05em;
    }

    .project-chart-panel .chart-bar-track {
      flex: 1;
      height: 14px;
      background: var(--canvas-elevated);
      overflow: hidden;
    }

    .project-chart-panel .chart-bar-fill {
      height: 100%;
      background: #a78bfa;
      transition: width 0.3s ease;
    }

    .project-chart-panel .chart-value {
      font-size: 10px;
      color: var(--text-secondary);
      min-width: 40px;
      text-align: right;
    }

    .project-chart-panel .chart-title {
      font-size: 10px;
      color: var(--text-tertiary);
      margin-bottom: 8px;
      letter-spacing: 0.1em;
      text-transform: lowercase;
    }

    /* Collapsible section headers */
    .section-toggle {
      display: flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      user-select: none;
    }

    .section-toggle:hover .toggle-arrow {
      color: var(--text-secondary);
    }

    .toggle-arrow {
      font-size: 10px;
      color: var(--text-tertiary);
      transition: transform 0.2s ease, color 0.15s ease;
      display: inline-block;
      width: 12px;
    }

    .toggle-arrow.collapsed {
      transform: rotate(-90deg);
    }

    .section-body.collapsed {
      display: none;
    }

    /* Search */
    .search-container {
      margin-bottom: 24px;
      display: none;
    }

    .search-input-wrap {
      position: relative;
    }

    .search-input {
      width: 100%;
      background: var(--canvas-surface);
      border: 1px solid var(--border);
      color: var(--text-primary);
      font-family: inherit;
      font-size: 12px;
      padding: 10px 14px 10px 32px;
      outline: none;
      transition: border-color 0.15s ease;
      text-transform: lowercase;
      letter-spacing: 0.05em;
    }

    .search-input::placeholder {
      color: var(--text-tertiary);
      letter-spacing: 0.08em;
    }

    .search-input:focus {
      border-color: var(--accent-primary);
    }

    .search-icon {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-tertiary);
      font-size: 11px;
      pointer-events: none;
    }

    .search-meta {
      font-size: 10px;
      color: var(--text-tertiary);
      text-transform: lowercase;
      letter-spacing: 0.05em;
      margin-top: 8px;
    }

    .search-results {
      margin-top: 8px;
      max-height: 500px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .search-result {
      background: var(--canvas-surface);
      border: 1px solid var(--border);
      padding: 12px 16px;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .search-result:hover {
      border-color: var(--accent-primary);
      background: var(--canvas-elevated);
    }

    .search-result-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
    }

    .search-result-time {
      font-size: 10px;
      color: var(--accent-primary);
      letter-spacing: 0.05em;
    }

    .search-result-project {
      font-size: 9px;
      color: #a78bfa;
      background: #a78bfa10;
      border: 1px solid #a78bfa20;
      padding: 1px 6px;
      letter-spacing: 0.05em;
    }

    .search-result-role {
      font-size: 9px;
      color: var(--text-tertiary);
      letter-spacing: 0.08em;
      text-transform: lowercase;
    }

    .search-result-snippet {
      font-size: 11px;
      color: var(--text-secondary);
      line-height: 1.5;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .search-result-snippet mark {
      background: #fbbf2440;
      color: #fbbf24;
      padding: 0 1px;
    }

    /* Empty state */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-tertiary);
      text-transform: lowercase;
      letter-spacing: 0.1em;
    }

    /* Hidden file inputs */
    #file-input, #folder-input {
      display: none;
    }
  </style>
</head>
<body>
  <input type="file" id="file-input" multiple accept=".jsonl,.json">
  <input type="file" id="folder-input" webkitdirectory>

  <div class="container">
    <div class="header">
      <h1 class="title">conversation stats</h1>
      <div class="month-nav">
        <button id="prev-month">&larr; prev</button>
        <span class="month-label" id="month-label">jan 2026</span>
        <button id="next-month">next &rarr;</button>
      </div>
    </div>

    <div class="drop-zone" id="drop-zone">
      <div class="drop-zone-text">
        <span>drag & drop</span> conversation files here (.jsonl)
      </div>
      <div class="file-count" id="file-count"></div>
    </div>

    <div class="stats-bar" id="stats-bar" style="display: none;">
      <div class="stats-group">
        <span class="stats-expand-arrow" id="stats-month-arrow" onclick="toggleStatsChart('month')">&#9654;</span>
        <span class="stats-group-label" id="stats-month-label">this month</span>
        <div class="stat-item">
          <span class="stat-label">convos:</span>
          <span class="stat-value" id="stat-month-convos">0</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">messages:</span>
          <span class="stat-value" id="stat-month-messages">0</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">hours:</span>
          <span class="stat-value" id="stat-month-hours">0</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">projects:</span>
          <span class="stat-value" id="stat-month-projects">0</span>
        </div>
      </div>
      <div class="stats-group">
        <span class="stats-expand-arrow" id="stats-total-arrow" onclick="toggleStatsChart('total')">&#9654;</span>
        <span class="stats-group-label">total</span>
        <div class="stat-item">
          <span class="stat-label">convos:</span>
          <span class="stat-value" id="stat-total-convos">0</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">messages:</span>
          <span class="stat-value" id="stat-total-messages">0</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">hours:</span>
          <span class="stat-value" id="stat-total-hours">0</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">projects:</span>
          <span class="stat-value" id="stat-total-projects">0</span>
        </div>
      </div>
    </div>
    <div class="stats-charts-row" id="stats-charts-row" style="display:none">
      <div class="stats-chart-panel" id="stats-chart-month" style="display:none"></div>
      <div class="stats-chart-panel" id="stats-chart-total" style="display:none"></div>
    </div>

    <div class="search-container" id="search-container">
      <div class="search-input-wrap">
        <span class="search-icon">/</span>
        <input type="text" class="search-input" id="search-input" placeholder="search conversations...">
      </div>
      <div class="search-meta" id="search-meta"></div>
      <div class="search-results" id="search-results"></div>
    </div>

    <div class="project-ranking" id="project-ranking" style="display: none;">
      <div class="project-ranking-title section-toggle" onclick="toggleSection('projects')">
        <span class="toggle-arrow" id="arrow-projects">▼</span>
        <span id="projects-title-text">projects this month</span>
      </div>
      <div class="section-body" id="body-projects">
        <div class="view-mode-toggle" id="view-mode-toggle">
          <span class="view-mode-label active-label" id="label-grouped">grouped</span>
          <div class="slide-toggle" id="view-mode-slider" onclick="toggleViewMode()"></div>
          <span class="view-mode-label" id="label-specific">specific</span>
          <span style="width:1px;height:14px;background:var(--border);margin:0 6px;flex-shrink:0"></span>
          <span class="view-mode-label active-label" id="label-month">this month</span>
          <div class="slide-toggle" id="time-range-slider" onclick="toggleTimeRange()"></div>
          <span class="view-mode-label" id="label-alltime">all time</span>
        </div>
        <div class="project-rank-list" id="project-rank-list"></div>
      </div>
    </div>

    <div class="weekly-summary" id="weekly-summary" style="display: none;">
      <div class="weekly-summary-title section-toggle" onclick="toggleSection('weekly')">
        <span class="toggle-arrow" id="arrow-weekly">▼</span>
        weekly summary
      </div>
      <div class="section-body" id="body-weekly">
        <div class="week-cards" id="week-cards"></div>
      </div>
    </div>

    <div class="toggle-container section-toggle" onclick="toggleSection('heatmap')">
      <span class="toggle-arrow" id="arrow-heatmap">▼</span>
      <span class="toggle-label">heatmap:</span>
      <div class="toggle-switch" onclick="event.stopPropagation()">
        <button class="toggle-option active" data-mode="messages">messages</button>
        <button class="toggle-option" data-mode="time">time</button>
        <button class="toggle-option" data-mode="projects">projects</button>
      </div>
    </div>

    <div class="section-body" id="body-heatmap">
      <div class="filter-bar" id="filter-bar" style="display: none;">
        <span class="filter-label">filtered:</span>
        <span class="filter-project" id="filter-project"></span>
        <button class="filter-clear" id="filter-clear">clear</button>
      </div>

      <div class="heatmap-container" id="heatmap-container">
        <div class="heatmap" id="heatmap"></div>
        <div class="legend" id="heatmap-legend"></div>
      </div>
    </div>
  </div>

  <!-- Day conversations overlay -->
  <div class="overlay" id="day-overlay">
    <div class="overlay-inner">
      <div class="overlay-header">
        <span class="overlay-title" id="day-overlay-title">conversations</span>
        <button class="overlay-close" id="day-overlay-close">esc to close</button>
      </div>
      <div class="overlay-content">
        <div class="convo-list" id="convo-list"></div>
      </div>
    </div>
  </div>

  <!-- Conversation view overlay -->
  <div class="overlay" id="convo-overlay">
    <div class="overlay-inner">
      <div class="overlay-header">
        <span class="overlay-title" id="convo-overlay-title">conversation</span>
        <button class="overlay-close" id="convo-overlay-close">esc to close</button>
      </div>
      <div class="overlay-content">
        <div id="convo-messages"></div>
      </div>
    </div>
  </div>

  <script>
    // State
    let conversations = [];
    let currentYear = new Date().getFullYear();
    let currentMonth = new Date().getMonth();
    let displayMode = 'messages'; // 'messages' or 'time'
    let selectedProject = null; // null = show all
    let projectViewMode = 'grouped'; // 'grouped' or 'specific'
    let rankingTimeRange = 'month'; // 'month' or 'alltime'

    // DOM elements
    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('file-input');
    const fileCount = document.getElementById('file-count');
    const heatmap = document.getElementById('heatmap');
    const monthLabel = document.getElementById('month-label');
    const prevMonthBtn = document.getElementById('prev-month');
    const nextMonthBtn = document.getElementById('next-month');
    const statsBar = document.getElementById('stats-bar');
    const dayOverlay = document.getElementById('day-overlay');
    const convoOverlay = document.getElementById('convo-overlay');
    const dayOverlayTitle = document.getElementById('day-overlay-title');
    const convoOverlayTitle = document.getElementById('convo-overlay-title');
    const convoList = document.getElementById('convo-list');
    const convoMessages = document.getElementById('convo-messages');

    // Month names
    const monthNames = ['jan', 'feb', 'mar', 'apr', 'may', 'jun',
                        'jul', 'aug', 'sep', 'oct', 'nov', 'dec'];

    // Project color palette
    const projectColorPalette = [
      '#a78bfa', '#6ee7b7', '#60a5fa', '#fb923c', '#f472b6',
      '#fbbf24', '#22d3ee', '#f87171', '#2dd4bf', '#818cf8',
      '#a3e635', '#e879f9', '#38bdf8', '#fb7185', '#34d399'
    ];
    const projectColorMap = {};
    let nextColorIdx = 0;

    function getProjectColor(projKey) {
      if (!projectColorMap[projKey]) {
        projectColorMap[projKey] = projectColorPalette[nextColorIdx % projectColorPalette.length];
        nextColorIdx++;
      }
      return projectColorMap[projKey];
    }

    // Initialize
    function init() {
      setupDropZone();
      setupMonthNav();
      setupToggle();
      setupOverlays();
      setupFilter();
      setupSearch();
      restoreSectionStates();
      renderHeatmap();
    }

    // Collapsible sections with cookie persistence
    function toggleSection(name) {
      const arrow = document.getElementById(`arrow-${name}`);
      const body = document.getElementById(`body-${name}`);
      const isCollapsed = body.classList.toggle('collapsed');
      arrow.classList.toggle('collapsed', isCollapsed);
      saveSectionStates();
    }

    function saveSectionStates() {
      const states = {};
      ['projects', 'weekly', 'heatmap'].forEach(name => {
        const body = document.getElementById(`body-${name}`);
        if (body) states[name] = body.classList.contains('collapsed');
      });
      states.viewMode = projectViewMode;
      states.timeRange = rankingTimeRange;
      document.cookie = `sectionStates=${JSON.stringify(states)};path=/;max-age=31536000`;
    }

    function restoreSectionStates() {
      const match = document.cookie.match(/sectionStates=([^;]+)/);
      if (!match) return;
      try {
        const states = JSON.parse(match[1]);
        for (const [name, value] of Object.entries(states)) {
          if (name === 'viewMode') {
            if (value === 'grouped' || value === 'specific') {
              projectViewMode = value;
            }
            continue;
          }
          if (name === 'timeRange') {
            if (value === 'month' || value === 'alltime') {
              rankingTimeRange = value;
            }
            continue;
          }
          if (value) {
            const arrow = document.getElementById(`arrow-${name}`);
            const body = document.getElementById(`body-${name}`);
            if (arrow && body) {
              body.classList.add('collapsed');
              arrow.classList.add('collapsed');
            }
          }
        }
        updateViewModeUI();
      } catch (e) {}
    }

    // Project filter
    function setupFilter() {
      document.getElementById('filter-clear').addEventListener('click', () => {
        toggleProjectFilter(null);
      });
    }

    function toggleProjectFilter(project) {
      if (selectedProject === project || project === null) {
        selectedProject = null;
        document.getElementById('filter-bar').style.display = 'none';
      } else {
        selectedProject = project;
        document.getElementById('filter-project').textContent = project;
        document.getElementById('filter-bar').style.display = 'flex';
      }
      renderProjectRanking();
      renderWeeklySummary();
      renderHeatmap();
    }

    // Search
    let searchTimeout = null;

    function setupSearch() {
      const input = document.getElementById('search-input');
      input.addEventListener('input', () => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => runSearch(input.value.trim()), 200);
      });
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          input.value = '';
          document.getElementById('search-results').innerHTML = '';
          document.getElementById('search-meta').textContent = '';
          input.blur();
        }
      });
    }

    function runSearch(query) {
      const resultsEl = document.getElementById('search-results');
      const metaEl = document.getElementById('search-meta');

      if (query.length < 2) {
        resultsEl.innerHTML = '';
        metaEl.textContent = '';
        return;
      }

      const lowerQ = query.toLowerCase();
      const results = [];
      const maxResults = 50;

      for (const convo of conversations) {
        for (const msg of convo.messages) {
          if (results.length >= maxResults) break;
          const idx = msg.content.toLowerCase().indexOf(lowerQ);
          if (idx !== -1) {
            results.push({ convo, msg, idx });
          }
        }
        if (results.length >= maxResults) break;
      }

      metaEl.textContent = results.length >= maxResults
        ? `${maxResults}+ matches found`
        : `${results.length} match${results.length !== 1 ? 'es' : ''} found`;

      let html = '';
      for (const { convo, msg, idx } of results) {
        const d = msg.timestamp;
        const dateStr = `${monthNames[d.getMonth()]} ${d.getDate()}, ${d.getFullYear()}`;
        const time = d.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false });
        const projDisplay = convo.projectGroupedName || convo.project || '';

        // Build snippet with highlight
        const snippetStart = Math.max(0, idx - 60);
        const snippetEnd = Math.min(msg.content.length, idx + query.length + 60);
        let snippet = msg.content.slice(snippetStart, snippetEnd).replace(/\n/g, ' ');
        if (snippetStart > 0) snippet = '...' + snippet;
        if (snippetEnd < msg.content.length) snippet = snippet + '...';

        // Escape and highlight
        const before = escapeHtml(snippet.slice(0, idx - snippetStart + (snippetStart > 0 ? 3 : 0)));
        const match = escapeHtml(snippet.slice(idx - snippetStart + (snippetStart > 0 ? 3 : 0), idx - snippetStart + (snippetStart > 0 ? 3 : 0) + query.length));
        const after = escapeHtml(snippet.slice(idx - snippetStart + (snippetStart > 0 ? 3 : 0) + query.length));

        html += `<div class="search-result" data-convo-id="${escapeHtml(convo.id)}">`;
        html += `<div class="search-result-header">`;
        html += `<span class="search-result-time">${dateStr} ${time}</span>`;
        html += `<span class="search-result-role">${msg.role}</span>`;
        if (projDisplay) html += `<span class="search-result-project">${escapeHtml(projDisplay)}</span>`;
        html += `</div>`;
        html += `<div class="search-result-snippet">${before}<mark>${match}</mark>${after}</div>`;
        html += `</div>`;
      }

      resultsEl.innerHTML = html;

      // Click handlers
      resultsEl.querySelectorAll('.search-result').forEach(el => {
        el.addEventListener('click', () => {
          const convo = conversations.find(c => c.id === el.dataset.convoId);
          if (convo) showConversation(convo);
        });
      });
    }

    // Project grouping
    function computeProjectGroups() {
      const allPaths = [...new Set(conversations.filter(c => c.projectPath).map(c => c.projectPath))];
      allPaths.sort((a, b) => a.split('/').length - b.split('/').length);

      // Iteratively find roots, excluding over-broad directories (home/workspace dirs)
      const excluded = new Set();
      let roots = [];

      for (let iter = 0; iter < 5; iter++) {
        roots = [];
        for (const p of allPaths) {
          if (excluded.has(p)) continue;
          const isChild = roots.some(root => p.startsWith(root + '/'));
          if (!isChild) roots.push(p);
        }

        // Check each root: if it has 10+ descendant project paths, it's a
        // workspace/home directory, not a real project — exclude it
        let foundBroad = false;
        for (const root of roots) {
          const descendants = allPaths.filter(p => p !== root && p.startsWith(root + '/'));
          if (descendants.length >= 10) {
            excluded.add(root);
            foundBroad = true;
          }
        }
        if (!foundBroad) break;
      }

      // Assign groups based on final roots
      for (const convo of conversations) {
        if (!convo.projectPath) continue;

        const root = roots.find(r => convo.projectPath === r || convo.projectPath.startsWith(r + '/'));

        if (root) {
          const rootParts = root.split('/');
          const rootName = rootParts[rootParts.length - 1] || rootParts[rootParts.length - 2];
          convo.projectGroup = rootName;

          if (convo.projectPath === root) {
            convo.projectGroupedName = rootName;
          } else {
            const relativePath = convo.projectPath.slice(root.length + 1);
            convo.projectGroupedName = rootName + '/' + relativePath;
          }
        } else {
          // Excluded path or orphan — standalone project
          convo.projectGroup = convo.project;
          convo.projectGroupedName = convo.project;
        }
      }
    }

    function getProjectKey(convo) {
      if (projectViewMode === 'specific') return convo.project;
      return convo.projectGroup || convo.project;
    }

    function toggleViewMode() {
      projectViewMode = projectViewMode === 'grouped' ? 'specific' : 'grouped';
      selectedProject = null;
      document.getElementById('filter-bar').style.display = 'none';
      updateViewModeUI();
      saveSectionStates();
      updateStats();
      renderProjectRanking();
      renderWeeklySummary();
      renderHeatmap();
    }

    function toggleTimeRange() {
      rankingTimeRange = rankingTimeRange === 'month' ? 'alltime' : 'month';
      updateViewModeUI();
      saveSectionStates();
      renderProjectRanking();
    }

    function updateViewModeUI() {
      const slider = document.getElementById('view-mode-slider');
      const labelGrouped = document.getElementById('label-grouped');
      const labelSpecific = document.getElementById('label-specific');
      if (slider && labelGrouped && labelSpecific) {
        if (projectViewMode === 'specific') {
          slider.classList.add('toggled');
          labelGrouped.classList.remove('active-label');
          labelSpecific.classList.add('active-label');
        } else {
          slider.classList.remove('toggled');
          labelGrouped.classList.add('active-label');
          labelSpecific.classList.remove('active-label');
        }
      }
      const timeSlider = document.getElementById('time-range-slider');
      const labelMonth = document.getElementById('label-month');
      const labelAlltime = document.getElementById('label-alltime');
      const titleText = document.getElementById('projects-title-text');
      if (timeSlider && labelMonth && labelAlltime) {
        if (rankingTimeRange === 'alltime') {
          timeSlider.classList.add('toggled');
          labelMonth.classList.remove('active-label');
          labelAlltime.classList.add('active-label');
          if (titleText) titleText.textContent = 'projects all time';
        } else {
          timeSlider.classList.remove('toggled');
          labelMonth.classList.add('active-label');
          labelAlltime.classList.remove('active-label');
          if (titleText) titleText.textContent = 'projects this month';
        }
      }
    }

    // Drop zone setup
    function setupDropZone() {
      const folderInput = document.getElementById('folder-input');
      dropZone.addEventListener('click', () => folderInput.click());
      folderInput.addEventListener('change', (e) => {
        const files = Array.from(e.target.files).filter(f => f.name.endsWith('.jsonl'));
        console.log('[import] Found', files.length, 'JSONL files in folder');
        for (const file of files) {
          readFile(file);
        }
      });

      dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('dragover');
      });

      dropZone.addEventListener('dragleave', () => {
        dropZone.classList.remove('dragover');
      });

      dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('dragover');
        handleDrop(e.dataTransfer.items);
      });

      fileInput.addEventListener('change', (e) => handleFiles(e.target.files));
    }

    // Handle drop - supports folders
    async function handleDrop(items) {
      const files = [];

      for (const item of items) {
        const entry = item.webkitGetAsEntry();
        if (entry) {
          await traverseEntry(entry, files);
        }
      }

      console.log('[drop] Found', files.length, 'JSONL files');
      for (const file of files) {
        readFile(file);
      }
    }

    // Recursively traverse directory entries
    async function traverseEntry(entry, files) {
      if (entry.isFile) {
        if (entry.name.endsWith('.jsonl')) {
          const file = await getFile(entry);
          files.push(file);
        }
      } else if (entry.isDirectory) {
        const reader = entry.createReader();
        const entries = await readAllEntries(reader);
        for (const childEntry of entries) {
          await traverseEntry(childEntry, files);
        }
      }
    }

    // Read all entries from a directory reader
    function readAllEntries(reader) {
      return new Promise((resolve) => {
        const entries = [];
        function readBatch() {
          reader.readEntries((batch) => {
            if (batch.length === 0) {
              resolve(entries);
            } else {
              entries.push(...batch);
              readBatch(); // Continue reading (directories can have many entries)
            }
          });
        }
        readBatch();
      });
    }

    // Get File object from FileEntry
    function getFile(fileEntry) {
      return new Promise((resolve) => {
        fileEntry.file(resolve);
      });
    }

    // Parse JSONL files using FileReader
    function handleFiles(files) {
      for (const file of files) {
        if (file.name.endsWith('.jsonl')) {
          readFile(file);
        }
      }
    }

    // Read a single file
    function readFile(file) {
      const reader = new FileReader();
      reader.onload = (e) => parseFileContent(e.target.result);
      reader.onerror = (e) => console.error('[error] Reading file:', file.name, e);
      reader.readAsText(file);
    }

    // Parse file content and extract conversations
    function parseFileContent(content) {
      const lines = content.split('\n').filter(l => l.trim());

      // Group messages by sessionId
      const sessions = {};

      for (const line of lines) {
        try {
          const data = JSON.parse(line);

          if (data.type === 'user' || data.type === 'assistant') {
            const sessionId = data.sessionId;
            const uuid = data.uuid;

            if (!sessions[sessionId]) {
              sessions[sessionId] = {
                id: sessionId,
                project: null,
                projectPath: null,
                messages: [],
                seenUuids: new Set(),
                startTime: null,
                endTime: null
              };
            }

            // Extract project from cwd
            if (data.cwd && !sessions[sessionId].projectPath) {
              sessions[sessionId].projectPath = data.cwd;
              const parts = data.cwd.split('/');
              sessions[sessionId].project = parts[parts.length - 1] || parts[parts.length - 2] || data.cwd;
            }

            // Skip if we already have this message (dedupe by uuid)
            if (sessions[sessionId].seenUuids.has(uuid)) {
              continue;
            }

            const timestamp = new Date(data.timestamp);
            const msgContent = extractContent(data.message);

            if (msgContent) {
              sessions[sessionId].seenUuids.add(uuid);
              sessions[sessionId].messages.push({
                role: data.type,
                content: msgContent,
                timestamp: timestamp
              });

              if (!sessions[sessionId].startTime || timestamp < sessions[sessionId].startTime) {
                sessions[sessionId].startTime = timestamp;
              }
              if (!sessions[sessionId].endTime || timestamp > sessions[sessionId].endTime) {
                sessions[sessionId].endTime = timestamp;
              }
            }
          }
        } catch (e) {
          console.error('[parse] Error parsing line:', e.message);
        }
      }
      // Merge sessions into conversations (merge into existing if same sessionId)
      for (const session of Object.values(sessions)) {
        if (session.messages.length === 0) continue;

        const existing = conversations.find(c => c.id === session.id);
        if (existing) {
          // Merge new messages (dedupe by timestamp+role)
          const existingKeys = new Set(existing.messages.map(m => m.timestamp.getTime() + m.role));
          for (const msg of session.messages) {
            const key = msg.timestamp.getTime() + msg.role;
            if (!existingKeys.has(key)) {
              existing.messages.push(msg);
              existingKeys.add(key);
            }
          }
          existing.messages.sort((a, b) => a.timestamp - b.timestamp);
          // Update time bounds
          if (session.startTime < existing.startTime) existing.startTime = session.startTime;
          if (session.endTime > existing.endTime) existing.endTime = session.endTime;
          if (!existing.project && session.project) existing.project = session.project;
          if (!existing.projectPath && session.projectPath) existing.projectPath = session.projectPath;
        } else {
          session.messages.sort((a, b) => a.timestamp - b.timestamp);
          delete session.seenUuids;
          conversations.push(session);
        }
      }

      computeProjectGroups();

      // Update UI
      fileCount.textContent = `${conversations.length} conversations loaded`;
      statsBar.style.display = 'flex';
      document.getElementById('search-container').style.display = 'block';
      updateStats();
      renderProjectRanking();
      renderWeeklySummary();
      renderHeatmap();
    }

    // Extract text content from message
    function extractContent(message) {
      if (!message || !message.content) {
        return null;
      }

      if (typeof message.content === 'string') {
        return message.content;
      }

      if (Array.isArray(message.content)) {
        const textParts = message.content
          .filter(c => c.type === 'text')
          .map(c => c.text);
        return textParts.length > 0 ? textParts.join('\n') : null;
      }

      return null;
    }

    // Update stats
    function updateStats() {
      // Update month label
      document.getElementById('stats-month-label').textContent = monthNames[currentMonth] + ' ' + currentYear;

      // --- This month stats ---
      let monthMsgCount = 0;
      const monthConvoIds = new Set();
      const monthProjects = new Set();
      const monthTs = [];

      for (const convo of conversations) {
        const projKey = getProjectKey(convo);
        for (const msg of convo.messages) {
          const d = msg.timestamp;
          if (d.getFullYear() === currentYear && d.getMonth() === currentMonth) {
            monthMsgCount++;
            monthConvoIds.add(convo.id);
            if (projKey) monthProjects.add(projKey);
            monthTs.push(d.getTime());
          }
        }
      }

      monthTs.sort((a, b) => a - b);
      let monthMinutes = 0;
      for (let i = 1; i < monthTs.length; i++) {
        const gap = (monthTs[i] - monthTs[i - 1]) / 60000;
        if (gap < 30) monthMinutes += gap;
      }
      const monthHours = monthMinutes / 60;

      document.getElementById('stat-month-convos').textContent = monthConvoIds.size;
      document.getElementById('stat-month-messages').textContent = monthMsgCount;
      document.getElementById('stat-month-hours').textContent = monthHours < 10 ? monthHours.toFixed(1) : Math.round(monthHours);
      document.getElementById('stat-month-projects').textContent = monthProjects.size;

      // --- Total stats ---
      const totalMessages = conversations.reduce((sum, c) => sum + c.messages.length, 0);
      const totalProjects = new Set(conversations.map(c => getProjectKey(c)).filter(Boolean));

      const allTs = [];
      for (const convo of conversations) {
        for (const msg of convo.messages) allTs.push(msg.timestamp.getTime());
      }
      allTs.sort((a, b) => a - b);
      let totalMinutes = 0;
      for (let i = 1; i < allTs.length; i++) {
        const gap = (allTs[i] - allTs[i - 1]) / 60000;
        if (gap < 30) totalMinutes += gap;
      }
      const totalHours = totalMinutes / 60;

      document.getElementById('stat-total-convos').textContent = conversations.length;
      document.getElementById('stat-total-messages').textContent = totalMessages;
      document.getElementById('stat-total-hours').textContent = totalHours < 10 ? totalHours.toFixed(1) : Math.round(totalHours);
      document.getElementById('stat-total-projects').textContent = totalProjects.size;

      // Re-render open stats charts
      if (document.getElementById('stats-chart-month').style.display !== 'none') renderStatsChart('month');
      if (document.getElementById('stats-chart-total').style.display !== 'none') renderStatsChart('total');
    }

    function toggleStatsChart(which) {
      const panel = document.getElementById('stats-chart-' + which);
      const arrow = document.getElementById('stats-' + which + '-arrow');
      const row = document.getElementById('stats-charts-row');

      if (panel.style.display !== 'none') {
        panel.style.display = 'none';
        arrow.classList.remove('open');
      } else {
        panel.style.display = '';
        arrow.classList.add('open');
        renderStatsChart(which);
      }

      // Hide the row container if both panels are hidden
      const monthVis = document.getElementById('stats-chart-month').style.display !== 'none';
      const totalVis = document.getElementById('stats-chart-total').style.display !== 'none';
      row.style.display = (monthVis || totalVis) ? '' : 'none';
    }

    function renderStatsChart(which) {
      const panel = document.getElementById('stats-chart-' + which);

      const allTs = [];
      for (const convo of conversations) {
        for (const msg of convo.messages) {
          allTs.push(msg.timestamp);
        }
      }
      allTs.sort((a, b) => a - b);

      const bucketMinutes = {};

      if (which === 'total') {
        // Hours by month across all time
        for (let i = 0; i < allTs.length; i++) {
          const d = allTs[i];
          const key = d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0');
          if (!bucketMinutes[key]) bucketMinutes[key] = 0;
          if (i > 0) {
            const gap = (d - allTs[i - 1]) / 60000;
            if (gap < 30) bucketMinutes[key] += gap;
          }
        }
      } else {
        // Hours by day for current month
        const filtered = allTs.filter(d =>
          d.getFullYear() === currentYear && d.getMonth() === currentMonth
        );
        for (let i = 0; i < filtered.length; i++) {
          const d = filtered[i];
          const key = String(d.getDate());
          if (!bucketMinutes[key]) bucketMinutes[key] = 0;
          if (i > 0) {
            const gap = (d - filtered[i - 1]) / 60000;
            if (gap < 30) bucketMinutes[key] += gap;
          }
        }
      }

      const buckets = [];
      let maxHours = 0;

      if (which === 'total') {
        const keys = Object.keys(bucketMinutes).sort();
        for (const key of keys) {
          const hrs = bucketMinutes[key] / 60;
          const [y, m] = key.split('-');
          const label = monthNames[parseInt(m) - 1] + ' ' + y.slice(2);
          buckets.push({ label, hours: hrs });
          if (hrs > maxHours) maxHours = hrs;
        }
      } else {
        const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
        for (let d = 1; d <= daysInMonth; d++) {
          const hrs = (bucketMinutes[String(d)] || 0) / 60;
          buckets.push({ label: String(d).padStart(2, '0'), hours: hrs });
          if (hrs > maxHours) maxHours = hrs;
        }
      }

      const title = which === 'total' ? 'hours by month' : 'hours by day';
      const color = which === 'total' ? '#a78bfa' : 'var(--accent-primary)';

      let html = `<div class="chart-title">${title}</div>`;
      html += '<div class="chart-bars">';

      for (const b of buckets) {
        const pct = maxHours > 0 ? Math.round((b.hours / maxHours) * 100) : 0;
        const hrsDisplay = b.hours.toFixed(1);
        html += `<div class="chart-row">`;
        html += `<span class="chart-label">${b.label}</span>`;
        html += `<div class="chart-bar-track"><div class="chart-bar-fill" style="width:${pct}%;background:${color}"></div></div>`;
        html += `<span class="chart-value">${hrsDisplay}h</span>`;
        html += `</div>`;
      }

      html += '</div>';
      panel.innerHTML = html;
    }

    // Weekly summary
    const dayNames = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'];

    function getWeekKey(date) {
      const d = new Date(date);
      d.setHours(0, 0, 0, 0);
      const day = d.getDay() || 7;
      d.setDate(d.getDate() + 4 - day);
      const yearStart = new Date(d.getFullYear(), 0, 1);
      const weekNum = Math.ceil(((d - yearStart) / 86400000 + 1) / 7);
      return d.getFullYear() + '-W' + String(weekNum).padStart(2, '0');
    }

    function getWeekRange(date) {
      const d = new Date(date);
      d.setHours(0, 0, 0, 0);
      const day = d.getDay() || 7;
      const mon = new Date(d);
      mon.setDate(d.getDate() - day + 1);
      const sun = new Date(mon);
      sun.setDate(mon.getDate() + 6);
      const opts = { month: 'short', day: 'numeric' };
      return mon.toLocaleDateString('en-US', opts).toLowerCase() + ' – ' +
             sun.toLocaleDateString('en-US', opts).toLowerCase() + ', ' + sun.getFullYear();
    }

    function getDayKey(date) {
      const d = new Date(date);
      return d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
    }

    function renderProjectRanking() {
      const container = document.getElementById('project-ranking');
      const listEl = document.getElementById('project-rank-list');

      if (conversations.length === 0) {
        container.style.display = 'none';
        return;
      }

      // Count messages per project
      const projectMessages = {};
      for (const convo of conversations) {
        const projKey = getProjectKey(convo);
        if (!projKey) continue;
        for (const msg of convo.messages) {
          if (rankingTimeRange === 'month') {
            const d = msg.timestamp;
            if (d.getFullYear() !== currentYear || d.getMonth() !== currentMonth) continue;
          }
          if (!projectMessages[projKey]) projectMessages[projKey] = 0;
          projectMessages[projKey]++;
        }
      }

      // Sort by message count descending
      const ranked = Object.entries(projectMessages).sort((a, b) => b[1] - a[1]);

      if (ranked.length === 0) {
        container.style.display = 'none';
        return;
      }

      const maxMsgs = ranked[0][1];
      // Remember which charts were expanded
      const prevExpanded = new Set();
      listEl.querySelectorAll('.project-chart-panel').forEach(el => {
        if (el.dataset.project) prevExpanded.add(el.dataset.project);
      });

      let html = '';
      for (let i = 0; i < ranked.length; i++) {
        const [name, msgs] = ranked[i];
        const pct = maxMsgs > 0 ? Math.round((msgs / maxMsgs) * 100) : 0;
        const isActive = selectedProject === name;
        const isExpanded = prevExpanded.has(name);
        const safeId = 'chart-' + name.replace(/[^a-zA-Z0-9]/g, '_');
        html += `<div class="project-rank-item${isActive ? ' active' : ''}" onclick="toggleProjectFilter('${escapeHtml(name)}')" data-project="${escapeHtml(name)}">`;
        html += `<span class="expand-arrow${isExpanded ? ' open' : ''}" onclick="event.stopPropagation(); toggleProjectChart('${escapeHtml(name)}')">&#9654;</span>`;
        html += `<span class="project-rank-pos">${i + 1}</span>`;
        html += `<span class="project-rank-name">${escapeHtml(name)}</span>`;
        html += `<div class="project-rank-bar"><div class="project-rank-bar-fill" style="width:${pct}%"></div></div>`;
        html += `<span class="project-rank-msgs">${msgs} msgs</span>`;
        html += `</div>`;
        if (isExpanded) {
          html += `<div class="project-chart-panel" data-project="${escapeHtml(name)}" id="${safeId}"></div>`;
        }
      }

      listEl.innerHTML = html;
      container.style.display = '';

      // Render charts for expanded panels
      prevExpanded.forEach(name => renderProjectChart(name));
    }

    function toggleProjectChart(projName) {
      const listEl = document.getElementById('project-rank-list');
      const safeId = 'chart-' + projName.replace(/[^a-zA-Z0-9]/g, '_');
      const existing = document.getElementById(safeId);

      if (existing) {
        // Collapse: remove chart panel
        existing.remove();
        // Update arrow
        const item = listEl.querySelector(`.project-rank-item[data-project="${CSS.escape(projName)}"]`);
        if (item) {
          const arrow = item.querySelector('.expand-arrow');
          if (arrow) arrow.classList.remove('open');
        }
      } else {
        // Expand: insert chart panel after the rank item
        const item = listEl.querySelector(`.project-rank-item[data-project="${CSS.escape(projName)}"]`);
        if (!item) return;
        const panel = document.createElement('div');
        panel.className = 'project-chart-panel';
        panel.dataset.project = projName;
        panel.id = safeId;
        item.after(panel);
        // Update arrow
        const arrow = item.querySelector('.expand-arrow');
        if (arrow) arrow.classList.add('open');
        renderProjectChart(projName);
      }
    }

    function renderProjectChart(projName) {
      const safeId = 'chart-' + projName.replace(/[^a-zA-Z0-9]/g, '_');
      const panel = document.getElementById(safeId);
      if (!panel) return;

      // Collect all timestamps for this project
      const projConvos = conversations.filter(c => getProjectKey(c) === projName);
      const allTimestamps = [];

      for (const convo of projConvos) {
        for (const msg of convo.messages) {
          allTimestamps.push(msg.timestamp);
        }
      }

      allTimestamps.sort((a, b) => a - b);

      if (allTimestamps.length === 0) {
        panel.innerHTML = '<div class="chart-title">no data</div>';
        return;
      }

      // Compute hours using gap-based algorithm (gaps < 30min)
      const bucketMinutes = {};

      if (rankingTimeRange === 'alltime') {
        // Group by month
        for (let i = 0; i < allTimestamps.length; i++) {
          const d = allTimestamps[i];
          const key = d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0');
          if (!bucketMinutes[key]) bucketMinutes[key] = 0;
          if (i > 0) {
            const gap = (d - allTimestamps[i - 1]) / 60000;
            if (gap < 30) {
              bucketMinutes[key] += gap;
            }
          }
        }
      } else {
        // Group by day within current month
        const filteredTs = allTimestamps.filter(d =>
          d.getFullYear() === currentYear && d.getMonth() === currentMonth
        );
        for (let i = 0; i < filteredTs.length; i++) {
          const d = filteredTs[i];
          const key = String(d.getDate());
          if (!bucketMinutes[key]) bucketMinutes[key] = 0;
          if (i > 0) {
            const gap = (d - filteredTs[i - 1]) / 60000;
            if (gap < 30) {
              bucketMinutes[key] += gap;
            }
          }
        }
      }

      // Convert to hours and find max
      const buckets = [];
      let maxHours = 0;

      if (rankingTimeRange === 'alltime') {
        // Build sorted month keys with nice labels
        const keys = Object.keys(bucketMinutes).sort();
        for (const key of keys) {
          const hrs = bucketMinutes[key] / 60;
          const [y, m] = key.split('-');
          const label = monthNames[parseInt(m) - 1] + ' ' + y.slice(2);
          buckets.push({ label, hours: hrs });
          if (hrs > maxHours) maxHours = hrs;
        }
      } else {
        // Build day keys for current month
        const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
        for (let d = 1; d <= daysInMonth; d++) {
          const key = String(d);
          const hrs = (bucketMinutes[key] || 0) / 60;
          if (hrs > 0 || d <= new Date().getDate() || currentMonth !== new Date().getMonth() || currentYear !== new Date().getFullYear()) {
            buckets.push({ label: String(d).padStart(2, '0'), hours: hrs });
          }
          if (hrs > maxHours) maxHours = hrs;
        }
      }

      const color = getProjectColor(projName);
      const title = rankingTimeRange === 'alltime' ? 'hours by month' : 'hours by day';

      let html = `<div class="chart-title">${title}</div>`;
      html += '<div class="chart-bars">';

      for (const b of buckets) {
        const pct = maxHours > 0 ? Math.round((b.hours / maxHours) * 100) : 0;
        const hrsDisplay = b.hours < 0.1 && b.hours > 0
          ? b.hours.toFixed(1)
          : b.hours < 1 ? b.hours.toFixed(1) : b.hours.toFixed(1);
        html += `<div class="chart-row">`;
        html += `<span class="chart-label">${b.label}</span>`;
        html += `<div class="chart-bar-track"><div class="chart-bar-fill" style="width:${pct}%;background:${color}"></div></div>`;
        html += `<span class="chart-value">${hrsDisplay}h</span>`;
        html += `</div>`;
      }

      html += '</div>';
      panel.innerHTML = html;
    }

    function renderWeeklySummary() {
      const container = document.getElementById('weekly-summary');
      const cardsEl = document.getElementById('week-cards');

      if (conversations.length === 0) {
        container.style.display = 'none';
        return;
      }

      // Only show weeks for the current month
      const weeks = {};
      const weekOrder = [];

      for (const convo of conversations) {
        for (const msg of convo.messages) {
          const d = msg.timestamp;
          if (d.getFullYear() === currentYear && d.getMonth() === currentMonth) {
            const wk = getWeekKey(d);
            if (!weeks[wk]) {
              weeks[wk] = { messages: 0, convos: new Set(), projects: new Set(), range: getWeekRange(d), days: {} };
              weekOrder.push(wk);
            }
            weeks[wk].messages++;
            weeks[wk].convos.add(convo.id);
            const projKey = getProjectKey(convo);
            if (projKey) weeks[wk].projects.add(projKey);

            const dk = getDayKey(d);
            if (!weeks[wk].days[dk]) {
              weeks[wk].days[dk] = { messages: 0, convos: new Set(), dow: d.getDay() };
            }
            weeks[wk].days[dk].messages++;
            weeks[wk].days[dk].convos.add(convo.id);
          }
        }
      }

      weekOrder.sort();

      if (weekOrder.length === 0) {
        container.style.display = 'none';
        return;
      }

      // Find the first week each project ever appeared (across all data)
      const projectFirstWeek = {};
      for (const convo of conversations) {
        const pfKey = getProjectKey(convo);
        if (!pfKey) continue;
        for (const msg of convo.messages) {
          const wk = getWeekKey(msg.timestamp);
          if (!projectFirstWeek[pfKey] || wk < projectFirstWeek[pfKey]) {
            projectFirstWeek[pfKey] = wk;
          }
        }
      }

      // Find max for bar scaling
      let maxMessages = 0;
      let maxDayMessages = 0;
      for (const wk of weekOrder) {
        if (weeks[wk].messages > maxMessages) maxMessages = weeks[wk].messages;
        for (const dk in weeks[wk].days) {
          if (weeks[wk].days[dk].messages > maxDayMessages) maxDayMessages = weeks[wk].days[dk].messages;
        }
      }

      let html = '';
      for (const wk of weekOrder) {
        const data = weeks[wk];
        const barPct = maxMessages > 0 ? Math.round((data.messages / maxMessages) * 100) : 0;
        const convoCount = data.convos.size;

        html += `<div class="week-card" onclick="this.querySelector('.week-days').classList.toggle('open')">`;
        html += `<div class="week-label">${data.range}</div>`;
        html += `<div class="week-stats">`;
        html += `<div class="week-stat"><div class="num">${data.projects.size}</div><div class="lbl">projects</div></div>`;
        html += `<div class="week-stat"><div class="num">${convoCount}</div><div class="lbl">convos</div></div>`;
        html += `<div class="week-stat"><div class="num">${data.messages}</div><div class="lbl">messages</div></div>`;
        html += `</div>`;
        html += `<div class="week-bar-track"><div class="week-bar-fill" style="width:${barPct}%"></div></div>`;

        // Project tags
        if (data.projects.size > 0) {
          html += `<div class="week-projects">`;
          for (const proj of data.projects) {
            const isNew = projectFirstWeek[proj] === wk;
            const isActive = selectedProject === proj;
            html += `<span class="project-tag${isNew ? ' new' : ''}${isActive ? ' active' : ''}" onclick="event.stopPropagation(); toggleProjectFilter('${escapeHtml(proj)}')">${escapeHtml(proj)}${isNew ? ' ✱' : ''}</span>`;
          }
          html += `</div>`;
        }

        // Daily breakdown
        html += `<div class="week-days">`;
        const dayKeys = Object.keys(data.days).sort();
        for (const dk of dayKeys) {
          const dd = data.days[dk];
          const dayPct = maxDayMessages > 0 ? Math.round((dd.messages / maxDayMessages) * 100) : 0;
          const dayNum = parseInt(dk.split('-')[2]);
          html += `<div class="day-bar-row" onclick="event.stopPropagation(); scrollToHeatmapDay(${dayNum})">`;
          html += `<div class="day-bar-label">${dayNames[dd.dow]}</div>`;
          html += `<div class="day-bar-track-inner"><div class="day-bar-fill-inner" style="width:${dayPct}%"></div></div>`;
          html += `<div class="day-bar-count">${dd.convos.size}c / ${dd.messages}m</div>`;
          html += `</div>`;
        }
        html += `</div></div>`;
      }

      cardsEl.innerHTML = html;
      container.style.display = '';
    }

    // Month navigation
    function setupMonthNav() {
      prevMonthBtn.addEventListener('click', () => {
        currentMonth--;
        if (currentMonth < 0) {
          currentMonth = 11;
          currentYear--;
        }
        updateMonthLabel();
        updateStats();
        renderProjectRanking();
        renderWeeklySummary();
        renderHeatmap();
      });

      nextMonthBtn.addEventListener('click', () => {
        currentMonth++;
        if (currentMonth > 11) {
          currentMonth = 0;
          currentYear++;
        }
        updateMonthLabel();
        updateStats();
        renderProjectRanking();
        renderWeeklySummary();
        renderHeatmap();
      });

      updateMonthLabel();
    }

    function updateMonthLabel() {
      monthLabel.textContent = `${monthNames[currentMonth]} ${currentYear}`;
    }

    // Toggle setup
    function setupToggle() {
      const toggleOptions = document.querySelectorAll('.toggle-option');
      toggleOptions.forEach(btn => {
        btn.addEventListener('click', () => {
          toggleOptions.forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          displayMode = btn.dataset.mode;
          renderHeatmap();
        });
      });
    }

    // Render heatmap
    function renderHeatmap() {
      heatmap.innerHTML = '';

      // Get days in month
      const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();

      // Build data grid - iterate individual messages
      const grid = {};
      let maxValue = 0;

      // Collect all messages for this month, sorted globally (respecting project filter)
      const filteredConvos = selectedProject
        ? conversations.filter(c => getProjectKey(c) === selectedProject)
        : conversations;
      const monthMessages = [];
      for (const convo of filteredConvos) {
        for (const msg of convo.messages) {
          const d = msg.timestamp;
          if (d.getFullYear() === currentYear && d.getMonth() === currentMonth) {
            monthMessages.push(d);

            const day = d.getDate();
            const hour = d.getHours();
            const key = `${day}-${hour}`;

            if (!grid[key]) {
              grid[key] = { messages: 0, time: 0, projects: new Set() };
            }

            grid[key].messages++;
            const hpk = getProjectKey(convo);
            if (hpk) grid[key].projects.add(hpk);
          }
        }
      }

      // Sort all messages globally and calculate time from gaps < 30min
      monthMessages.sort((a, b) => a - b);
      for (let i = 1; i < monthMessages.length; i++) {
        const gap = (monthMessages[i] - monthMessages[i - 1]) / 60000;
        if (gap < 30) {
          const d = monthMessages[i];
          const day = d.getDate();
          const hour = d.getHours();
          const key = `${day}-${hour}`;
          if (grid[key]) {
            grid[key].time += gap;
          }
        }
      }

      // Find max for scaling
      for (const key in grid) {
        const val = displayMode === 'messages' ? grid[key].messages
                  : displayMode === 'projects' ? grid[key].projects.size
                  : grid[key].time;
        if (val > maxValue) maxValue = val;
      }

      // Header row
      const headerCorner = document.createElement('div');
      headerCorner.className = 'heatmap-header';
      heatmap.appendChild(headerCorner);

      for (let h = 0; h < 24; h++) {
        const header = document.createElement('div');
        header.className = 'heatmap-header';
        header.textContent = h.toString().padStart(2, '0');
        heatmap.appendChild(header);
      }

      // Data rows
      for (let day = 1; day <= daysInMonth; day++) {
        const dayLabel = document.createElement('div');
        dayLabel.className = 'day-label';
        dayLabel.id = `heatmap-day-${day}`;
        dayLabel.textContent = day;
        heatmap.appendChild(dayLabel);

        for (let hour = 0; hour < 24; hour++) {
          const cell = document.createElement('div');
          cell.className = 'heatmap-cell';

          const key = `${day}-${hour}`;
          const data = grid[key];

          if (data) {
            const projCount = data.projects.size;
            const projNames = projCount > 0 ? Array.from(data.projects).join(', ') : '';

            if (displayMode === 'projects' && projCount > 0) {
              const colors = Array.from(data.projects).map(p => getProjectColor(p));
              if (colors.length === 1) {
                cell.style.background = colors[0];
              } else {
                const pct = 100 / colors.length;
                const stops = colors.map((c, i) => `${c} ${i * pct}% ${(i + 1) * pct}%`).join(', ');
                cell.style.background = `linear-gradient(135deg, ${stops})`;
              }
              cell.title = `${projNames} — ${data.messages} msgs`;
            } else {
              const val = displayMode === 'messages' ? data.messages : data.time;
              const level = getHeatLevel(val, maxValue);
              cell.classList.add(`heat-${level}`);
              const msgInfo = displayMode === 'messages'
                ? `${data.messages} messages`
                : `${Math.round(data.time)} min`;
              cell.title = projNames
                ? `${msgInfo} — ${projNames}`
                : msgInfo;
            }
          }

          cell.addEventListener('click', () => showDayConversations(day, hour));
          heatmap.appendChild(cell);
        }
      }

      // Render legend
      const legendEl = document.getElementById('heatmap-legend');
      if (displayMode === 'projects') {
        const monthProjects = new Set();
        for (const key in grid) {
          for (const p of grid[key].projects) monthProjects.add(p);
        }
        let lhtml = '';
        for (const p of monthProjects) {
          const c = getProjectColor(p);
          lhtml += `<span style="display:inline-flex;align-items:center;gap:4px;margin-right:10px;cursor:pointer" onclick="toggleProjectFilter('${escapeHtml(p)}')">`;
          lhtml += `<span style="width:10px;height:10px;background:${c};flex-shrink:0"></span>`;
          lhtml += `<span class="legend-label" style="color:${selectedProject === p ? '#fff' : ''}">${escapeHtml(p)}</span>`;
          lhtml += `</span>`;
        }
        legendEl.innerHTML = lhtml;
        legendEl.style.flexWrap = 'wrap';
      } else {
        legendEl.innerHTML = `
          <span class="legend-label">less</span>
          <div class="legend-scale">
            <div class="legend-box" style="background: var(--heat-0);"></div>
            <div class="legend-box" style="background: var(--heat-1);"></div>
            <div class="legend-box" style="background: var(--heat-2);"></div>
            <div class="legend-box" style="background: var(--heat-3);"></div>
            <div class="legend-box" style="background: var(--heat-4);"></div>
            <div class="legend-box" style="background: var(--heat-5);"></div>
          </div>
          <span class="legend-label">more</span>`;
        legendEl.style.flexWrap = '';
      }
    }

    // Get heat level (1-5) based on value
    function getHeatLevel(value, max) {
      if (!value || !max) return 0;
      const ratio = value / max;
      if (ratio < 0.2) return 1;
      if (ratio < 0.4) return 2;
      if (ratio < 0.6) return 3;
      if (ratio < 0.8) return 4;
      return 5;
    }

    // Show conversations for a day (any message on that day, respecting project filter)
    function showDayConversations(day, hour) {
      const source = selectedProject
        ? conversations.filter(c => getProjectKey(c) === selectedProject)
        : conversations;
      const dayConvos = source.filter(c => {
        return c.messages.some(m => {
          const d = m.timestamp;
          return d.getFullYear() === currentYear &&
                 d.getMonth() === currentMonth &&
                 d.getDate() === day;
        });
      });

      if (dayConvos.length === 0) {
        return;
      }

      // Sort by time
      dayConvos.sort((a, b) => a.startTime - b.startTime);

      // Update title
      const dateStr = `${monthNames[currentMonth]} ${day}, ${currentYear}`;
      const hourStr = hour != null ? ` ${String(hour).padStart(2, '0')}:00` : '';
      dayOverlayTitle.textContent = `${dateStr}${hourStr} - ${dayConvos.length} conversation${dayConvos.length > 1 ? 's' : ''}`;

      // Render list
      convoList.innerHTML = '';
      for (const convo of dayConvos) {
        const item = document.createElement('div');
        item.className = 'convo-item';

        const time = convo.startTime.toLocaleTimeString('en-US', {
          hour: '2-digit',
          minute: '2-digit',
          hour12: false
        });

        const firstUserMsg = convo.messages.find(m => m.role === 'user');
        const preview = firstUserMsg ? firstUserMsg.content.slice(0, 100) : '(no preview)';

        const duration = convo.endTime && convo.startTime
          ? Math.round((convo.endTime - convo.startTime) / 60000)
          : 0;

        const projDisplay = convo.projectGroupedName || convo.project;
        const projectTag = projDisplay ? `<span class="convo-project">${escapeHtml(projDisplay)}</span>` : '';

        item.innerHTML = `
          <div class="convo-time">${time}</div>
          <div class="convo-preview">${escapeHtml(preview)}${preview.length >= 100 ? '...' : ''}</div>
          <div class="convo-meta">${convo.messages.length} messages${duration > 0 ? ` / ${duration} min` : ''}</div>
          ${projectTag}
        `;

        item.addEventListener('click', () => showConversation(convo, day, hour));
        convoList.appendChild(item);
      }

      dayOverlay.classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    // Show full conversation
    function showConversation(convo, targetDay, targetHour) {
      const time = convo.startTime.toLocaleTimeString('en-US', {
        hour: '2-digit',
        minute: '2-digit',
        hour12: false
      });
      const dateStr = `${monthNames[convo.startTime.getMonth()]} ${convo.startTime.getDate()}, ${convo.startTime.getFullYear()}`;
      const projName = convo.projectGroupedName || convo.project;
      const projectStr = projName ? ` — ${projName}` : '';
      convoOverlayTitle.textContent = `${dateStr} at ${time}${projectStr}`;

      convoMessages.innerHTML = '';
      let firstHighlight = null;

      for (const msg of convo.messages) {
        const msgEl = document.createElement('div');
        msgEl.className = 'message';

        const msgTime = msg.timestamp.toLocaleTimeString('en-US', {
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit',
          hour12: false
        });
        const msgDate = msg.timestamp.toLocaleDateString('en-US', {
          month: 'short',
          day: 'numeric'
        }).toLowerCase();

        // Highlight messages matching the target day+hour
        const isTarget = targetDay != null && targetHour != null &&
          msg.timestamp.getFullYear() === currentYear &&
          msg.timestamp.getMonth() === currentMonth &&
          msg.timestamp.getDate() === targetDay &&
          msg.timestamp.getHours() === targetHour;

        if (isTarget) {
          msgEl.classList.add('highlighted');
          if (!firstHighlight) firstHighlight = msgEl;
        }

        msgEl.innerHTML = `
          <div class="message-role-line">
            <div class="message-role ${msg.role}">${msg.role}</div>
            <span class="message-time">${msgDate} ${msgTime}</span>
          </div>
          <div class="message-content">${escapeHtml(msg.content)}</div>
        `;

        convoMessages.appendChild(msgEl);
      }

      convoOverlay.scrollTop = 0;
      convoOverlay.classList.add('active');
      document.body.style.overflow = 'hidden';

      // Scroll to first highlighted message after layout settles
      if (firstHighlight) {
        setTimeout(() => {
          firstHighlight.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }, 80);
      }
    }

    // Overlays setup
    function setupOverlays() {
      // Close buttons
      document.getElementById('day-overlay-close').addEventListener('click', () => {
        dayOverlay.classList.remove('active');
        document.body.style.overflow = '';
      });

      document.getElementById('convo-overlay-close').addEventListener('click', () => {
        convoOverlay.classList.remove('active');
        document.body.style.overflow = '';
      });

      // Click outside (on the dark backdrop) to close
      dayOverlay.addEventListener('click', (e) => {
        if (e.target === dayOverlay) {
          dayOverlay.classList.remove('active');
          document.body.style.overflow = '';
        }
      });

      convoOverlay.addEventListener('click', (e) => {
        if (e.target === convoOverlay) {
          convoOverlay.classList.remove('active');
          document.body.style.overflow = '';
        }
      });

      // ESC key
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          if (convoOverlay.classList.contains('active')) {
            convoOverlay.classList.remove('active');
            document.body.style.overflow = '';
          } else if (dayOverlay.classList.contains('active')) {
            dayOverlay.classList.remove('active');
            document.body.style.overflow = '';
          }
        }
      });
    }

    // Scroll to heatmap day row and briefly highlight it
    function scrollToHeatmapDay(day) {
      const el = document.getElementById(`heatmap-day-${day}`);
      if (el) {
        el.scrollIntoView({ behavior: 'smooth', block: 'center' });
        // Get the row bounding box from label to last cell
        let lastCell = el;
        let sibling = el.nextElementSibling;
        for (let i = 0; i < 24 && sibling; i++) {
          lastCell = sibling;
          sibling = sibling.nextElementSibling;
        }
        const container = document.getElementById('heatmap');
        const containerRect = container.getBoundingClientRect();
        const startRect = el.getBoundingClientRect();
        const endRect = lastCell.getBoundingClientRect();

        // Create a single highlight rectangle
        const highlight = document.createElement('div');
        highlight.style.cssText = `
          position: absolute;
          top: ${startRect.top - containerRect.top}px;
          left: ${startRect.left - containerRect.left}px;
          width: ${endRect.right - startRect.left}px;
          height: ${endRect.bottom - startRect.top}px;
          border: 1px solid var(--accent-primary);
          pointer-events: none;
          transition: opacity 0.3s ease;
        `;
        container.style.position = 'relative';
        container.appendChild(highlight);
        setTimeout(() => {
          highlight.style.opacity = '0';
          setTimeout(() => highlight.remove(), 300);
        }, 1200);
      }
    }

    // Escape HTML
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Start
    init();
  </script>
</body>
</html>
